---
app-id: org.learningequality.Kolibri
runtime: org.gnome.Platform
runtime-version: '3.36'
sdk: org.gnome.Sdk
command: kolibri-gnome

finish-args:
  - --device=dri
  - --share=ipc
  - --share=network
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11

add-extensions:
  org.learningequality.Kolibri.Content:
    version: '1.0'
    directory: share/kolibri-content
    subdirectories: true
    no-autodownload: true

modules:
  - python3-ifaddr.json

  - name: python-zeroconf-py2compat
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/learningequality/python-zeroconf-py2compat.git
        branch: master
      - type: patch
        path: python-zeroconf-py2compat-0001-Replace-ifcfg-with-ifaddr.patch

  - name: python3-kolibri
    buildsystem: simple
    build-commands:
      - pip3 install --exists-action=i --no-index --find-links="file://${PWD}/wheel" --prefix=${FLATPAK_DEST} kolibri
      - cp -R git/kolibri/core ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/
      - cp -R git/kolibri/deployment ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/
      - cp -R git/kolibri/locale ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/
      - cp -R git/kolibri/plugins ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/
      - cp -R git/kolibri/utils ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/
      - rm -r ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/dist/zeroconf.py
      - ln -s ${FLATPAK_DEST}/lib/python3.7/site-packages/zeroconf.py ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/dist/zeroconf.py
      - ln -s ${FLATPAK_DEST}/lib/python3.7/site-packages/ifaddr ${FLATPAK_DEST}/lib/python3.7/site-packages/kolibri/dist/ifaddr
      - mkdir -p ${FLATPAK_DEST}/libexec
      - mv ${FLATPAK_DEST}/bin/kolibri ${FLATPAK_DEST}/libexec/kolibri
    sources:
      - type: file
        url: https://buildkite.com/organizations/learningequality/pipelines/kolibri-python-package/builds/664/jobs/0d017578-26b9-45c7-a1fd-4e2bd94b1139/artifacts/d6bc3b59-5e63-4681-9788-3c6eb6431d8c
        sha256: 29efe4af115b91675b1f070d6a0ee686c454b7f1e0d46fd985073dd31b3a5767
        dest: wheel
        dest-filename: kolibri-0.13.3a0.dev0+git.49.gb4428b46-py2.py3-none-any.whl
      - type: git
        url: https://github.com/jamalex/kolibri.git
        # branch: content_fallback_paths
        commit: 642276165d12350672af0ffa7f89324155599f4d
        dest: git

  - python3-requests.json

  - python3-virtualenv-api.json

  - name: pyeverywhere
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: git
        url: https://github.com/kollivier/pyeverywhere.git
        # branch: dev
        commit: 63cdb6dd642ebce4af6a5134dbabcd4bd4f2a96d

  - name: kolibri-installer-gnome
    buildsystem: meson
    config-opts:
      - -Dkolibri_home_template_dir=/app/share/kolibri-home-template
    sources:
      - type: git
        url: https://github.com/learningequality/kolibri-installer-gnome.git
        # branch: master
        commit: ac505f3d1b6c9c04180f17fc735b7914919f1baf

  - name: kolibri-home-template
    buildsystem: simple
    build-options:
      env:
        KOLIBRI_HOME: /app/share/kolibri-home-template
    build-commands:
      - install -d ${KOLIBRI_HOME}
      - yes 'yes' | ${FLATPAK_DEST}/libexec/kolibri manage migrate
      - yes 'yes' | ${FLATPAK_DEST}/libexec/kolibri manage collectstatic
      - yes 'yes' | ${FLATPAK_DEST}/libexec/kolibri manage deprovision
      - rm -r ${KOLIBRI_HOME}/logs
      - rm -r ${KOLIBRI_HOME}/sessions
      - rm -r ${KOLIBRI_HOME}/process_cache
      - touch ${KOLIBRI_HOME}/was_preseeded

  - name: kolibri-content-dir
    buildsystem: simple
    build-commands:
      - install -d -m 755 ${FLATPAK_DEST}/share/kolibri-content

  - name: kolibri-flatpak-utils
    buildsystem: simple
    build-commands:
      - pip3 install --prefix=${FLATPAK_DEST} .
    sources:
      - type: dir
        path: kolibri-flatpak-utils
