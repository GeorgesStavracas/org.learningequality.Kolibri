From 55706d3fbb28ff967817072c1e08035fd5b8466c Mon Sep 17 00:00:00 2001
From: Dylan McCall <dylan@endlessm.com>
Date: Wed, 20 Nov 2019 14:38:47 -0800
Subject: [PATCH] Periodically poll a heartbeat URL if set

---
 .../context_processors/custom_context_processor.py    |  5 +++++
 kolibri/core/templates/kolibri/base.html              | 11 +++++++++++
 kolibri/deployment/default/settings/base.py           |  1 +
 3 files changed, 17 insertions(+)

diff --git a/kolibri/core/context_processors/custom_context_processor.py b/kolibri/core/context_processors/custom_context_processor.py
index 088dfe84a..882a4257c 100644
--- a/kolibri/core/context_processors/custom_context_processor.py
+++ b/kolibri/core/context_processors/custom_context_processor.py
@@ -1,5 +1,10 @@
 from django.conf import settings
+import os
 
 
 def developer_mode(request):
     return {"developer_mode": getattr(settings, "DEVELOPER_MODE", False)}
+
+
+def heartbeat_port(request):
+    return {"heartbeat_port": os.environ.get("KOLIBRI_HEARTBEAT_PORT")}
diff --git a/kolibri/core/templates/kolibri/base.html b/kolibri/core/templates/kolibri/base.html
index 3319ab244..ebd3a0e36 100644
--- a/kolibri/core/templates/kolibri/base.html
+++ b/kolibri/core/templates/kolibri/base.html
@@ -27,6 +27,17 @@
   {% kolibri_theme %}
   {% kolibri_set_urls %}
   {% webpack_asset 'user_agent' %}
+  {% if heartbeat_port %}
+    <script>
+      var callbackURL = new URL('/', location);
+      callbackURL.port = "{{ heartbeat_port }}";
+      var newImage = new Image();
+      setInterval(function() {
+        callbackURL.search = new Date().getTime();
+        newImage.src = callbackURL.href;
+      }, 30000);
+    </script>
+  {% endif %}
 </head>
 <body>
 <rootvue>
diff --git a/kolibri/deployment/default/settings/base.py b/kolibri/deployment/default/settings/base.py
index 15685e5e5..ed930812d 100644
--- a/kolibri/deployment/default/settings/base.py
+++ b/kolibri/deployment/default/settings/base.py
@@ -121,6 +121,7 @@ TEMPLATES = [
                 "django.contrib.auth.context_processors.auth",
                 "django.contrib.messages.context_processors.messages",
                 "kolibri.core.context_processors.custom_context_processor.developer_mode",
+                "kolibri.core.context_processors.custom_context_processor.heartbeat_port",
             ]
         },
     }
-- 
2.24.1

